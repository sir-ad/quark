---
description: v1.3.1 Hotfix Plan — Fix broken table pasting from Excel Online to Teams/Slack/Notion
---

# Quark v1.3.1 Hotfix: 3-Bug Fix Plan

## Context for the Executing Model

**Project**: Quark Clipboard Micro-Daemon (`/Users/starlord/Downloads/quark-2`)
**Problem**: Copying tables from Excel Online → pasting into Teams Desktop (or any Electron app) results in jumbled strings instead of intact tables.
**Root Cause**: 3 independent bugs identified by RCA. Each maps to one sub-agent below.
**Goal**: Fix all 3 bugs, run QA, bump to v1.3.1, push to GitHub with tag.

---

## Sub-Agent 1: Clipboard Engineer — Fix `writeHtml` in `clipboard.js`

**File**: `cli/src/clipboard.js`
**Problem**: Lines 50-60 use AppleScript `«class HTML»` + `«data utxt»` to write HTML to clipboard. This is the **primary cause of failure**. AppleScript crashes silently on large/complex HTML payloads. Also, Electron apps (Teams, Slack) read `public.html` from NSPasteboard, NOT `«class HTML»`.

**Fix**: Replace the entire macOS branch of `writeHtml` (lines 50-60) with a JXA-based NSPasteboard writer that sets `public.html` and `public.utf8-plain-text` natively.

**Exact replacement for lines 50-60**:
```javascript
if (platform === 'darwin') {
  // Use JXA to write both public.html and public.utf8-plain-text to NSPasteboard
  // This ensures Electron apps (Teams, Slack) can read the HTML correctly
  const escapedHtml = html.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/\n/g, '\\n');
  const escapedText = plainText.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/\n/g, '\\n');
  const jxa = `
    ObjC.import("AppKit");
    var pb = $.NSPasteboard.generalPasteboard;
    pb.clearContents;
    pb.setStringForType($('${escapedHtml}'), $('public.html'));
    pb.setStringForType($('${escapedText}'), $('public.utf8-plain-text'));
    "ok";
  `;
  execSync(`osascript -l JavaScript -e '${jxa.replace(/\n/g, ' ')}' 2>/dev/null`);
}
```

**Verification**: After this change, run `quark run` in foreground, copy a table from Excel Online in Chrome, and confirm the daemon log shows `TRANSFORM` without errors. Then paste into Teams — the table should render with borders.

---

## Sub-Agent 2: Transformer Scientist — Fix preservation heuristic in `transformers.js`

**File**: `cli/src/transformers.js`
**Problem**: Lines 242-257. The forensic markers list includes `<table`, `<tbody`, `<thead`. When Excel Online's HTML is successfully read (which contains `<table`), the heuristic returns `{ changed: false }` — Quark does NOTHING. But Chrome's raw HTML has no inline CSS borders, so it pastes as invisible/broken tables.

**Fix**: When `<table` is detected in `originalHtml`, instead of skipping entirely, **re-style the table** with inline CSS borders to ensure it renders everywhere. Replace lines 242-257 with:

```javascript
  // PRESERVATION HEURISTIC: If high-quality HTML exists, enhance it instead of skipping
  if (originalHtml) {
    const forensicMarkers = [
      'data-sheets-value',
      'data-sheets-userformat',
      'br-re-calc',
      'x-office-spreadsheet',
    ];
    const hasSpreadsheetMeta = forensicMarkers.some(marker => originalHtml.toLowerCase().includes(marker));
    const hasTable = originalHtml.toLowerCase().includes('<table');
    
    if (hasTable) {
      // Re-style existing tables with inline CSS for universal rendering
      let styledHtml = originalHtml
        .replace(/<table/gi, '<table style="border-collapse: collapse; font-family: sans-serif; font-size: 14px;"')
        .replace(/<th(?=[ >])/gi, '<th style="border: 1px solid #d1d1d1; padding: 6px 12px; background-color: #f3f2f1;"')
        .replace(/<td(?=[ >])/gi, '<td style="border: 1px solid #d1d1d1; padding: 6px 12px;"');
      
      return { 
        changed: true, 
        text: text, 
        html: styledHtml, 
        markdown: convertToMarkdown(styledHtml),
        skipReason: 'Table re-styled for universal rendering'
      };
    }
    
    if (hasSpreadsheetMeta && !hasTable) {
      return { changed: false, text: text, html: originalHtml, markdown: result.markdown, skipReason: 'Spreadsheet metadata preserved' };
    }
  }
```

**Key change**: Tables are no longer "skipped" — they are *enhanced* with inline borders so every app renders them correctly.

---

## Sub-Agent 3: Integration Fixer — Fix `markdownApps` list in `daemon.js`

**File**: `cli/src/daemon.js`
**Problem**: Line 142. Teams is listed in `markdownApps`. Teams is an Electron app that renders `public.html` — sending it Markdown as plain text makes tables appear as `| col1 | col2 |` pipe characters.

**Fix**: Remove `'Teams'` from the markdownApps array on line 142:

```javascript
// BEFORE:
const markdownApps = ['Obsidian', 'Visual Studio Code', 'Cursor', 'Linear', 'GitHub', 'Teams'];

// AFTER:
const markdownApps = ['Obsidian', 'Visual Studio Code', 'Cursor', 'Linear', 'GitHub'];
```

---

## Sub-Agent 4: QA Engineer — Verify

1. Run `node qa_v130.cjs` — all existing tests must still pass.
2. Create a minimal new test in `qa_v131.cjs` that verifies:
   - When `processClipboard` receives HTML with a `<table>`, it returns `changed: true` with re-styled HTML containing `border: 1px solid`.
   - The markdown field is populated.
3. Run `quark run` and manually copy a table from Excel Online → paste into Teams.

---

## Sub-Agent 5: DevOps — Release

1. In `package.json`, change `"version": "1.3.0"` → `"version": "1.3.1"`.
2. Run:
```bash
cd /Users/starlord/Downloads/quark-2
git add .
git commit -m "fix: rewrite clipboard writer to JXA NSPasteboard, fix table preservation heuristic, remove Teams from markdown targets (v1.3.1)"
git tag v1.3.1
git push origin main
git push origin v1.3.1
```

---

## File Reference Summary

| File | Lines to Change | What to Do |
|------|----------------|------------|
| `cli/src/clipboard.js` | 50-60 | Replace AppleScript with JXA NSPasteboard writer |
| `cli/src/transformers.js` | 242-257 | Replace skip-heuristic with table re-styling logic |
| `cli/src/daemon.js` | 142 | Remove `'Teams'` from markdownApps |
| `package.json` | 3 | `1.3.0` → `1.3.1` |
